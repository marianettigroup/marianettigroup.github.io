{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "# Phonons\n",
    "\n",
    "Phonon is one of the most important physical quantities that are been studied in this package.\n",
    "We have gone through the methods for computation of the second order Taylor series of the BO energy \n",
    "in LID and BID chapters, here we use the resulting dynamic matrices from those approaches to compute\n",
    "phonon frequencies."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Diagonalization\n",
    "\n",
    "In order to compute phonons from dynamic matrices, we need to solve the phonon eigenvalue problem:\n",
    "$$\n",
    "\\hat{D} \\left| W \\right> = \\lambda \\hat{M} \\left| W \\right> = \\omega^2 \\hat{M} \\left| W \\right>\n",
    "$$\n",
    "where $\\hat{D}$ is the dynamic matrix, $\\left| W \\right>$ is phonon eigen vectors, $\\hat{M}$ the mass matrix,\n",
    "and $\\lambda$ eigenvalues which equals square of phonon frequencies $\\omega$."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Dipole dipole contribution\n",
    "\n",
    "For insulators like rocksalt and florite materials, \n",
    "we need to include the long-ranged dipole-dipole interaction for the phonon dispersion.\n",
    "\n",
    "We can account for this contribution using the Ewald summation.\n",
    "First, we subtract the dipole terms $\\tilde{C}^{DD}(\\textbf{q})$ from the dynamic matrices $\\hat{D}(\\textbf{q})$.\n",
    "Then we can Fourier interpolate the resulting dynamic matrices to arbitrary $\\textbf{q}$-points, \n",
    "and add the dipole effect $\\tilde{C}^{DD}(\\textbf{q})$ back.\n",
    "When add the dipole terms back, at the Brillouin zone center the term depends on the limiting direction of $\\textbf{q}\\to\\textbf{0}$.\n",
    "\n",
    "\n",
    "The formula for the dipole-dipole contribution is as follows:\n",
    "\n",
    "$$\n",
    "\\tilde{C}^{DD}_{\\kappa \\alpha \\kappa^{\\prime} \\beta} (\\textbf{q})\n",
    "=\n",
    "\\hat{C}^{DD}_{\\kappa \\alpha \\kappa^{\\prime} \\beta} (\\textbf{q})\n",
    "-\\delta_{\\kappa \\kappa^{\\prime}}\n",
    "\\sum_{\\kappa^{\\prime\\prime}}\n",
    "\\hat{C}^{DD}_{\\kappa \\alpha \\kappa^{\\prime\\prime} \\beta} (\\textbf{q}=\\bf{\\Gamma})\n",
    "$$\n",
    "\n",
    "$$\n",
    "\\hat{C}^{DD}_{\\kappa \\alpha \\kappa^{\\prime} \\beta} (\\textbf{q})\n",
    "=\n",
    "\\sum_{\\alpha^{\\prime} \\beta^{\\prime}}\n",
    "Z^{\\ast}_{\\kappa, \\alpha\\alpha^{\\prime}}\n",
    "Z^{\\ast}_{\\kappa^{\\prime}, \\beta\\beta^{\\prime}}\n",
    "\\overline{C}^{DD}_{\\kappa \\alpha^{\\prime} \\kappa^{\\prime} \\beta^{\\prime}} (\\textbf{q})\n",
    "$$\n",
    "\n",
    "$$\n",
    "\\overline{C}^{DD}_{\\kappa \\alpha \\kappa^{\\prime} \\beta} (\\textbf{q})\n",
    "=\n",
    "\\sum_{\\textbf{G} \\textrm{ with } \\textbf{K} = \\textbf{q} + \\textbf{G}} \n",
    "\\frac{4\\pi}{\\Omega}\n",
    "\\frac{K_{\\alpha}K_{\\beta}}{\n",
    "\\sum_{\\gamma\\gamma^{\\prime}} K_{\\gamma}\\epsilon_{\\gamma\\gamma^{\\prime}}K_{\\gamma^{\\prime}}\n",
    "}\n",
    "e^{i \\textbf{K} \\cdot (\\tau_{\\kappa} - \\tau_{\\kappa^{\\prime}})}\n",
    "\\exp{\\left(-\\frac{\n",
    "\\sum_{\\gamma\\gamma^{\\prime}} K_{\\gamma}\\epsilon_{\\gamma\\gamma^{\\prime}}K_{\\gamma^{\\prime}}\n",
    "}{4\\Lambda^2}\n",
    "\\right)\n",
    "}\n",
    "$$\n",
    "\n",
    "Here we only compute the reciprocal space sum.\n",
    "\n",
    "Ref:\n",
    "[X. Gonze, J.-C. Charlier, D. C. Allan, and M. P. Teter, Phys. Rev. B 50, 13035 (1994)](https://doi.org/10.1103/PhysRevB.50.13035),\n",
    "[X. Gonze and C. Lee, Phys. Rev. B 55, 10355 (1997)](https://doi.org/10.1103/PhysRevB.55.10355).\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "## Group velocity\n",
    "\n",
    "\n",
    "The group velocity is the $\\textbf{q}$ derivative of the phonon frequencies.\n",
    "The derivative can be taken with finite difference, but here we use the analytically formula to ensure accuracy.\n",
    "\n",
    "We can rewrite the derivative of phonon frequencies into derivatives of dynamical matricies.\n",
    "\n",
    "$$\n",
    "\\textbf{v}_g(\\textbf{q}j) =\n",
    "\\frac{\\partial \\omega_{\\textbf{q}j}}{\\partial \\textbf{q}}\n",
    "=\n",
    "\\frac{1}{2\\omega_{\\textbf{q}j}}\n",
    "\\frac{\\partial (\\omega_{\\textbf{q}j})^2}{\\partial \\textbf{q}}\n",
    "=\n",
    "\\frac{1}{2\\omega_{\\textbf{q}j}}\n",
    "\\frac{\\partial \\left<W_i(\\textbf{q})\\right|\\hat{D}(\\textbf{q})\\left|W_i(\\textbf{q})\\right>}{\\partial \\textbf{q}}\n",
    "= - \\frac{1}{2\\omega_{i}(\\textbf{q})} \n",
    "    \\left\\langle W_i(\\textbf{q})\\middle\\vert\n",
    "    \\frac{\\partial \\hat{D}(\\textbf{q})}{\\partial \\textbf{q}}\n",
    "    \\middle\\vert W_i(\\textbf{q}) \\right\\rangle\n",
    "$$\n",
    "\n",
    "Since dynamical matrices are computed with Fourier interpolation, we can write the $\\textbf{q}$ derivative as follows.\n",
    "\n",
    "$$\n",
    "\\frac{\\partial\\hat D_{\\mathbf{K}}}{\\partial K_\\alpha} = \n",
    "\\sum_{\\mathbf{t}} i T_\\alpha  e^{i\\mathbf{K} \n",
    "\\cdot \\mathbf{t}\\hat a} \\hat \\Phi_{\\mathbf{t}}\n",
    "$$\n",
    "\n",
    "When it comes to insulators with dipole-dipole contributions, the dipole part\n",
    "$\n",
    "\\frac{\\partial \\tilde{C}^{DD}_{\\kappa \\alpha \\kappa^{\\prime} \\beta} (\\textbf{q})}{\\partial \\textbf{q}}\n",
    "$\n",
    "is also analytically computed using chain rule of derivatives."
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3 (ipykernel)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.8.8"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 4
}
